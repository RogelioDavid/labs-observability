version: "3.4"
services:

  # The hello-observability application
  hello-observability.applications.svc.cluster.local:
    image: rmendoza/hello-observability-manual:v2
    volumes:
      - ./logs/hello-observability.log:/tmp/hello-observability.log
      - ./logs/access_log.log:/tmp/access_log.log
    environment:
      JAVA_TOOL_OPTIONS: -javaagent:./opentelemetry-javaagent.jar
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://otel-collector:4317
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SERVICE_NAME: hello-observability
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      OTEL_LOGS_EXPORTER: none      
      HOSTNAME: hello-observability.applications.svc.cluster.local
    ports:
      - "8080:8080"


  ms-service-app-ms1.applications.svc.cluster.local:
    image: rmendoza/ms-service-app-ms1-manual:v2
    volumes:
      # Log files. They are all also accessible to the agent container,
      # through docker volume mount
      - ./logs/ms-service-app-ms1.log:/tmp/ms-service-app-ms1.log
      - ./logs/access_log.log:/tmp/access_log.log
    environment:
      # Tracing configuration
      JAVA_TOOL_OPTIONS: -javaagent:./opentelemetry-javaagent.jar    
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://otel-collector:4317
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SERVICE_NAME: ms-service-app-ms1
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      OTEL_LOGS_EXPORTER: none      
      HOSTNAME: ms-service-app-ms1.applications.svc.cluster.local
    ports:
      - "8081:8081"

  ms-service-app-ms2.applications.svc.cluster.local:
    image: rmendoza/ms-service-app-ms2-manual:v2
    volumes:
      # Log files. They are all also accessible to the agent container,
      # through docker volume mount
      - ./logs/ms-service-app-ms2.log:/tmp/ms-service-app-ms2.log
      - ./logs/access_log.log:/tmp/access_log.log
    environment:
      # Tracing configuration
      JAVA_TOOL_OPTIONS: -javaagent:./opentelemetry-javaagent.jar    
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://otel-collector:4317
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SERVICE_NAME: ms-service-app-ms2
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      OTEL_LOGS_EXPORTER: none      
      HOSTNAME: ms-service-app-ms2.applications.svc.cluster.local
    ports:
      - "8082:8082"
  # Our load generator
  ubuntu-local:
    image: ubuntu
    restart: on-failure
    command: ["sleep","infinity"]

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.93.0
    container_name: otel-collector
    deploy:
      resources:
        limits:
          memory: 125M
    restart: unless-stopped
    command: [ "--config=/etc/otelcol-config.yml", "--config=/etc/otelcol-config-extras.yml" ]
    volumes:
      - ./config/otelcol-config.yml:/etc/otelcol-config.yml
      - ./config/otelcol-config-extras.yml:/etc/otelcol-config-extras.yml
    environment:
      HOSTNAME: otel-collector
    ports:
      - "4317"
      - "4318"
 

